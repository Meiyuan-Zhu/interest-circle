"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Validate = exports.CustomValidate = void 0;
const __1 = require("..");
const class_transformer_1 = require("class-transformer");
const joi = require("joi");
function CustomValidate(opt) {
    return (customOpt = {}) => Validate({ ...opt, ...customOpt });
}
exports.CustomValidate = CustomValidate;
function Validate(opt = true) {
    return function (target, propertyKey, descriptor) {
        const origin = descriptor.value;
        const paramTypes = (0, __1.getMethodParamTypes)(target, propertyKey);
        const options = typeof opt === 'boolean' ? { isTransform: opt } : opt;
        if (!('isTransform' in options)) {
            options.isTransform = true;
        }
        descriptor.value = function (...args) {
            for (let i = 0; i < paramTypes.length; i++) {
                const item = paramTypes[i];
                const rules = (0, __1.getClassExtendedMetadata)(__1.RULES_KEY, item);
                if (rules) {
                    const schema = joi.object(rules);
                    const result = schema.validate(args[i]);
                    if (result.error) {
                        if (options.errorStatus) {
                            result.error.status =
                                options.errorStatus;
                        }
                        throw result.error;
                    }
                    else {
                        args[i] = result.value;
                    }
                    // passed
                    if (options.isTransform) {
                        args[i] = (0, class_transformer_1.plainToClass)(item, args[i]);
                    }
                }
            }
            return origin.call(this, ...args);
        };
    };
}
exports.Validate = Validate;
//# sourceMappingURL=validate.js.map